from unitxt import add_to_catalog
from unitxt.metrics import RetrievalAtK
from unitxt.test_utils.metrics import test_metric

metric = RetrievalAtK(k_list=[1, 3, 5, 10, 20, 40])

predictions = [["a", "b", "c", "d", "e", "f"], ["g", "r", "u"], ["a", "b", "c"], []]

references = [[["c", "d"]], [["g"]], [[]], [["a"]]]  # third hit  # first hit  # no hit

instance_targets = [
    {
        "match_at_1": 0.0,
        "match_at_3": 1.0,
        "match_at_5": 1.0,
        "match_at_10": 1.0,
        "match_at_20": 1.0,
        "match_at_40": 1.0,
        "precision_at_1": 0.0,
        "precision_at_3": 0.33,
        "precision_at_5": 0.4,
        "precision_at_10": 0.33,
        "precision_at_20": 0.33,
        "precision_at_40": 0.33,
        "recall_at_1": 0.0,
        "recall_at_3": 0.5,
        "recall_at_5": 1.0,
        "recall_at_10": 1.0,
        "recall_at_20": 1.0,
        "recall_at_40": 1.0,
        "score": 0.0,
        "score_name": "match_at_1",
    },
    {
        "match_at_1": 1.0,
        "match_at_3": 1.0,
        "match_at_5": 1.0,
        "match_at_10": 1.0,
        "match_at_20": 1.0,
        "match_at_40": 1.0,
        "precision_at_1": 1.0,
        "precision_at_3": 0.33,
        "precision_at_5": 0.33,
        "precision_at_10": 0.33,
        "precision_at_20": 0.33,
        "precision_at_40": 0.33,
        "recall_at_1": 1.0,
        "recall_at_3": 1.0,
        "recall_at_5": 1.0,
        "recall_at_10": 1.0,
        "recall_at_20": 1.0,
        "recall_at_40": 1.0,
        "score": 1.0,
        "score_name": "match_at_1",
    },
    {
        "match_at_1": 0.0,
        "match_at_3": 0.0,
        "match_at_5": 0.0,
        "match_at_10": 0.0,
        "match_at_20": 0.0,
        "match_at_40": 0.0,
        "precision_at_1": 0.0,
        "precision_at_3": 0.0,
        "precision_at_5": 0.0,
        "precision_at_10": 0.0,
        "precision_at_20": 0.0,
        "precision_at_40": 0.0,
        "recall_at_1": 0,
        "recall_at_3": 0,
        "recall_at_5": 0,
        "recall_at_10": 0,
        "recall_at_20": 0,
        "recall_at_40": 0,
        "score": 0.0,
        "score_name": "match_at_1",
    },
    {
        "match_at_1": 0.0,
        "match_at_3": 0.0,
        "match_at_5": 0.0,
        "match_at_10": 0.0,
        "match_at_20": 0.0,
        "match_at_40": 0.0,
        "precision_at_1": 0.0,
        "precision_at_3": 0.0,
        "precision_at_5": 0.0,
        "precision_at_10": 0.0,
        "precision_at_20": 0.0,
        "precision_at_40": 0.0,
        "recall_at_1": 0.0,
        "recall_at_3": 0.0,
        "recall_at_5": 0.0,
        "recall_at_10": 0.0,
        "recall_at_20": 0.0,
        "recall_at_40": 0.0,
        "score": 0.0,
        "score_name": "match_at_1",
    },
]

global_target = {
    "match_at_1": 0.25,
    "match_at_10": 0.5,
    "match_at_10_ci_high": 1.0,
    "match_at_10_ci_low": 0.0,
    "match_at_1_ci_high": 0.75,
    "match_at_1_ci_low": 0.0,
    "match_at_20": 0.5,
    "match_at_20_ci_high": 1.0,
    "match_at_20_ci_low": 0.0,
    "match_at_3": 0.5,
    "match_at_3_ci_high": 1.0,
    "match_at_3_ci_low": 0.0,
    "match_at_40": 0.5,
    "match_at_40_ci_high": 1.0,
    "match_at_40_ci_low": 0.0,
    "match_at_5": 0.5,
    "match_at_5_ci_high": 1.0,
    "match_at_5_ci_low": 0.0,
    "precision_at_1": 0.25,
    "precision_at_10": 0.17,
    "precision_at_10_ci_high": 0.33,
    "precision_at_10_ci_low": 0.0,
    "precision_at_1_ci_high": 0.75,
    "precision_at_1_ci_low": 0.0,
    "precision_at_20": 0.17,
    "precision_at_20_ci_high": 0.33,
    "precision_at_20_ci_low": 0.0,
    "precision_at_3": 0.17,
    "precision_at_3_ci_high": 0.33,
    "precision_at_3_ci_low": 0.0,
    "precision_at_40": 0.17,
    "precision_at_40_ci_high": 0.33,
    "precision_at_40_ci_low": 0.0,
    "precision_at_5": 0.18,
    "precision_at_5_ci_high": 0.37,
    "precision_at_5_ci_low": 0.0,
    "recall_at_1": 0.25,
    "recall_at_10": 0.5,
    "recall_at_10_ci_high": 1.0,
    "recall_at_10_ci_low": 0.0,
    "recall_at_1_ci_high": 0.75,
    "recall_at_1_ci_low": 0.0,
    "recall_at_20": 0.5,
    "recall_at_20_ci_high": 1.0,
    "recall_at_20_ci_low": 0.0,
    "recall_at_3": 0.38,
    "recall_at_3_ci_high": 0.75,
    "recall_at_3_ci_low": 0.0,
    "recall_at_40": 0.5,
    "recall_at_40_ci_high": 1.0,
    "recall_at_40_ci_low": 0.0,
    "recall_at_5": 0.5,
    "recall_at_5_ci_high": 1.0,
    "recall_at_5_ci_low": 0.0,
    "score": 0.25,
    "score_ci_high": 0.75,
    "score_ci_low": 0.0,
    "score_name": "match_at_1",
}

outputs = test_metric(
    metric=metric,
    predictions=predictions,
    references=references,
    instance_targets=instance_targets,
    global_target=global_target,
)

add_to_catalog(metric, "metrics.retrieval_at_k", overwrite=True)
